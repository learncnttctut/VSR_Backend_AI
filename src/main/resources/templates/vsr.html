<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="VSR - Hệ thống AI nhận diện biển báo và hỗ trợ lái xe thông minh">
    <title>VSR - Hành trình</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <link rel="stylesheet" href="/css/style.css">
</head>

<body class="bg-light">

<div class="sticky-navbar-wrapper">
    <nav class="navbar navbar-expand-lg navbar-pill container shadow-lg py-2 px-4">
        <div class="container-fluid">
            <a class="navbar-brand vsr-logo-nav me-5" href="/index">VSR</a>

            <button class="navbar-toggler border-0" type="button" data-bs-toggle="collapse"
                    data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse justify-content-center" id="navbarNav">
                <ul class="navbar-nav gap-2 gap-lg-5">
                    <li class="nav-item">
                        <a class="nav-link nav-link-custom" href="/index">TRANG CHỦ</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link nav-link-custom active" href="/vsr">VSR</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link nav-link-custom" href="/contact">LIÊN HỆ</a>
                    </li>
                </ul>
            </div>

            <div class="d-none d-lg-block ms-5">
                <a href="/login" class="user-btn-pill shadow-sm" title="Đăng nhập tài khoản">
                    <i class="fa-solid fa-user"></i>
                </a>
            </div>
        </div>
    </nav>
</div>

<div class="vsr-dashboard-page">
    <div class="vsr-dash-main-container shadow-lg">
        <header class="vsr-dash-header d-flex justify-content-between align-items-center px-4 py-3">
            <div class="d-flex align-items-center gap-2">
                <span class="vsr-dash-pulse"></span>
                <span class="text-info fw-bold small">HỆ THỐNG VSR: LIVE</span>
            </div>
            <div class="vsr-dash-speed">
                <span class="speed-val">65</span><small>km/h</small>
            </div>
        </header>

        <main class="container-fluid p-4">
            <div class="row g-4 align-items-stretch">
                <style>
                    .v-marker {
                        transition: transform 0.3s ease-out;
                    }
                    #recenter-btn {
                        transition: all 0.2s ease;
                    }
                    #recenter-btn:hover {
                        background: #f0f0f0;
                        transform: scale(1.1);
                    }
                    #search-box-ui {
                        pointer-events: none;
                    }
                    #search-box-ui input,
                    #search-box-ui .list-group {
                        pointer-events: auto;
                    }
                </style>

                <!-- MAP COLUMN -->
                <div class="col-lg-5">
                    <div class="vsr-dash-card h-100"
                         style="background: #f8f9fa; border-radius: 25px; overflow: visible; position: relative; border: 1px solid #dee2e6;">

                        <div id="nav-instruction"
                             class="position-absolute top-0 start-50 translate-middle-x mt-3 shadow-lg"
                             style="z-index: 1100; width: 92%; display: none;">
                            <div class="bg-success text-white p-3 rounded-4 d-flex align-items-center">
                                <i class="fa-solid fa-location-arrow fs-2 me-3"></i>
                                <div>
                                    <div class="small opacity-75">Hướng về</div>
                                    <div class="fw-bold fs-5" id="street-name">Tuyến đường đã chọn</div>
                                </div>
                            </div>
                        </div>

                        <div class="vsr-dash-content-box position-relative" style="height: 450px;">
                            <button id="recenter-btn"
                                    class="btn btn-white shadow-lg rounded-circle position-absolute"
                                    style="z-index: 1000; bottom: 100px; right: 20px; width: 50px; height: 50px; display: none; border: 1px solid #ccc; background: white;">
                                <i class="fa-solid fa-location-crosshairs text-primary fs-4"></i>
                            </button>

                            <div id="search-box-ui" class="position-absolute top-0 start-50 translate-middle-x mt-3"
                                 style="z-index: 1000; width: 90%;">
                                <input type="text" id="dest-input"
                                       class="form-control border-0 rounded-pill px-4 shadow-sm"
                                       placeholder="Tìm điểm đến...">
                                <div id="suggest-box" class="list-group mt-1 shadow-lg border-0"></div>
                            </div>

                            <div id="leaflet-map" style="width: 100%; height: 100%;"></div>

                            <div id="trip-stats"
                                 class="position-absolute shadow-lg"
                                 style=" z-index:1100;  bottom:20px;  left:50%;  transform:translateX(-50%);  width:85%;  max-width:500px;  border-radius:25px;  display:none; background:white;">

                                <div class="p-3 d-flex justify-content-between align-items-center">

                                    <button class="btn btn-light rounded-circle shadow-sm"
                                            onclick="location.reload()"
                                            style="width:45px;height:45px;">
                                        <i class="fa-solid fa-xmark"></i>
                                    </button>

                                    <div class="text-center">
                                        <div class="text-success fw-bold fs-4 mb-0" id="time-left">
                                            -- phút
                                        </div>
                                        <div class="text-muted small">
                                            <span id="dist-left">--</span> km •
                                            <span id="arrival-time">--:--</span>
                                        </div>
                                    </div>

                                    <button id="start-nav"
                                            class="btn btn-primary rounded-pill px-4 fw-bold">
                                        BẮT ĐẦU
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-7">
                    <div class="vsr-dash-card h-100">
                        <div class="vsr-dash-card-label p-3 d-flex justify-content-between">
                            <span><i class="fa-solid fa-camera me-2"></i>GIÁM SÁT AI</span>
                            <span class="small text-info">30.0 FPS</span>
                        </div>
                        <div class="vsr-dash-content-box position-relative" style="height: 450px;">
                            <div class="vsr-dash-ai-target position-absolute"
                                 style="top:0; left:0; width:100%; height:100%;">
                                <img src="http://localhost:5000/video_feed" style="width:100%; height:100%; object-fit:cover;" />
<!--                                <img id="signImg" style="position:absolute; top:20px;right:20px;width:120px;background:white; padding:5px; border-radius:10px; display:none;" />-->

                                <div id="signContainer"
                                     style="position:absolute;
            top:20px;
            right:20px;
            display:flex;
            flex-direction:column;
            gap:10px;">
                                </div>


                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>
</div><

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>


<!--<script>-->
<!--    const signImg = document.getElementById("signImg");-->

<!--    let hideTimeout = null;-->
<!--    let lastImage = null;-->

<!--    setInterval(() => {-->
<!--        fetch("/api/current-sign")-->
<!--            .then(res => res.text())-->
<!--            .then(text => text ? JSON.parse(text) : null)-->
<!--            .then(data => {-->
<!--                if (!data || !data.image) return;-->

<!--                if (data.image === lastImage) return;-->

<!--                lastImage = data.image;-->

<!--                signImg.src = data.image;-->
<!--                signImg.style.display = "block";-->

<!--                if (hideTimeout) clearTimeout(hideTimeout);-->

<!--                hideTimeout = setTimeout(() => {-->
<!--                    signImg.style.display = "none";-->
<!--                    lastImage = null;-->
<!--                }, 5000);-->
<!--            })-->
<!--            .catch(() => {});-->
<!--    }, 1000);-->
<!--</script>-->

<script>
    const container = document.getElementById("signContainer");

    let showingSigns = new Set(); // chống trùng

    setInterval(() => {
        fetch("/api/current-sign")
            .then(res => res.json())
            .then(data => {
                if (!data || !data.id) return;

                // Nếu đang hiển thị rồi thì bỏ
                if (showingSigns.has(data.id)) return;

                showingSigns.add(data.id);

                // Tạo image mới
                const img = document.createElement("img");
                img.src = data.image;
                img.style.width = "120px";
                img.style.background = "white";
                img.style.padding = "5px";
                img.style.borderRadius = "10px";

                container.appendChild(img);

                // Sau 5s xoá nó
                setTimeout(() => {
                    container.removeChild(img);
                    showingSigns.delete(data.id);
                }, 5000);
            })
            .catch(() => {});
    }, 1000);
</script>


<script>
    let map, vehicleMarker, routeLine, destinationMarker;
    let currentPos = [10.0467, 105.7675]; // Tọa độ Cần Thơ
    let isNavigating = false;
    let autoCenter = true;

    function initMap() {
        map = L.map('leaflet-map', { zoomControl: false }).setView(currentPos, 16);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        setTimeout(() => map.invalidateSize(), 500);

        const navIcon = L.divIcon({
            className: 'v-marker',
            html: `
                <div id="vehicle-arrow" style="transform: rotate(0deg); display: flex; justify-content: center; align-items: center;">
                    <i class="fa-solid fa-location-arrow" style="color: #0d6efd; font-size: 30px; text-shadow: 0 0 10px white;"></i>
                </div>`,
            iconSize: [30, 30],
            iconAnchor: [15, 15]
        });

        vehicleMarker = L.marker(currentPos, { icon: navIcon }).addTo(map);

        setupNavigationEvents();
        setupRecenterLogic();
        startGPS();
    }

    function setupRecenterLogic() {
        const recenterBtn = document.getElementById('recenter-btn');

        map.on('dragstart', () => {
            autoCenter = false;
            recenterBtn.style.display = 'block';
        });

        recenterBtn.onclick = () => {
            autoCenter = true;
            recenterBtn.style.display = 'none';
            map.flyTo(currentPos, isNavigating ? 18 : 16, { animate: true });
        };
    }

    function setupNavigationEvents() {
        const input = document.getElementById('dest-input');
        const startBtn = document.getElementById('start-nav');

        input.addEventListener('input', function () {
            if (this.value.length > 2) {
                fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(this.value)}&limit=3&countrycodes=vn`)
                    .then(res => res.json())
                    .then(data => {
                        const suggestBox = document.getElementById('suggest-box');
                        suggestBox.innerHTML = '';
                        data.forEach(item => {
                            const div = document.createElement('div');
                            div.className = 'list-group-item list-group-item-action border-0 py-3';
                            div.innerText = item.display_name;
                            div.onclick = () => {
                                input.value = item.display_name;
                                suggestBox.innerHTML = '';
                                drawRealRoute(item.lat, item.lon);
                            };
                            suggestBox.appendChild(div);
                        });
                    });
            }
        });

        startBtn.onclick = () => {
            isNavigating = true;
            autoCenter = true;
            document.getElementById('search-box-ui').style.display = 'none';
            document.getElementById('nav-instruction').style.display = 'block';
            startBtn.style.display = 'none';
            map.flyTo(currentPos, 18, { animate: true, duration: 2 });
            if (routeLine) routeLine.setStyle({ weight: 12, color: '#4285F4', opacity: 1 });
        };
    }

    function drawRealRoute(destLat, destLon) {
        if (routeLine) map.removeLayer(routeLine);
        if (destinationMarker) map.removeLayer(destinationMarker);

        destinationMarker = L.marker([destLat, destLon]).addTo(map);

        const url = `https://router.project-osrm.org/route/v1/driving/${currentPos[1]},${currentPos[0]};${destLon},${destLat}?overview=full&geometries=geojson`;

        fetch(url).then(res => res.json()).then(data => {
            if (data.routes && data.routes.length > 0) {
                const route = data.routes[0];
                const coords = route.geometry.coordinates.map(c => [c[1], c[0]]);

                routeLine = L.polyline(coords, {
                    color: '#4285F4', weight: 8, opacity: 0.7, lineJoin: 'round'
                }).addTo(map);

                document.getElementById('dist-left').innerText = (route.distance / 1000).toFixed(1);
                document.getElementById('time-left').innerText = Math.round(route.duration / 60) + " phút";

                const arrival = new Date(Date.now() + route.duration * 1000);
                const hh = arrival.getHours().toString().padStart(2, '0');
                const mm = arrival.getMinutes().toString().padStart(2, '0');
                document.getElementById('arrival-time').innerText = hh + ':' + mm;

                document.getElementById('trip-stats').style.display = 'block';

                map.fitBounds(routeLine.getBounds(), { padding: [60, 100] });
            }
        });
    }

    function startGPS() {
        if (navigator.geolocation) {
            navigator.geolocation.watchPosition((pos) => {
                const { latitude, longitude, heading } = pos.coords;
                currentPos = [latitude, longitude];

                vehicleMarker.setLatLng(currentPos);

                if (heading !== null) {
                    const arrowEl = document.getElementById('vehicle-arrow');
                    if (arrowEl) {
                        arrowEl.style.transform = `rotate(${heading - 45}deg)`;
                    }
                }

                if (autoCenter) {
                    map.panTo(currentPos);
                }
            }, null, { enableHighAccuracy: true });
        }
    }

    window.onload = initMap;
</script>
</body>
</html>